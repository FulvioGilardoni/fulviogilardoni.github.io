<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comune Oliveto Lario</title>
  <style>
    :root {
      --bg1:#f8fafc; --bg2:#eef2ff; --card:#fff; --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary-600:#1d4ed8; --ring:rgba(37,99,235,.35);
      --ok:#065f46; --error:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2) 60%);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";color:var(--text);display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:640px;background:var(--card);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:20px}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .logo{width:42px;height:42px;border-radius:12px;background:radial-gradient(circle at 30% 30%,#93c5fd,#3b82f6);box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}
    h1{font-size:20px;margin:0}
    p.sub{margin:.25rem 0 0 0;color:var(--muted);font-size:.95rem}
    .field{margin-top:16px}
    label{display:block;font-weight:600;margin-bottom:8px}
    .select-wrap{position:relative}
    select{width:100%;font-size:1.05rem;padding:18px 44px 18px 16px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;outline:none;appearance:none;-webkit-appearance:none;-moz-appearance:none;transition:box-shadow .15s,border-color .15s,transform .05s}
    select:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    .select-wrap::after{content:"";position:absolute;right:14px;top:50%;transform:translateY(-50%);border:6px solid transparent;border-top-color:#6b7280;pointer-events:none}
    input[type=text]{width:100%;font-size:1.05rem;padding:18px 16px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;outline:none;transition:box-shadow .15s,border-color .15s,transform .05s}
    input[type=text]:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    .actions{margin-top:16px;display:flex;gap:12px}
    .btn{appearance:none;cursor:pointer;border:none;border-radius:14px;padding:16px 20px;font-size:1.05rem;font-weight:700;letter-spacing:.2px;background:var(--primary);color:#fff;box-shadow:0 8px 16px rgba(37,99,235,.25);transition:transform .06s ease,background .15s ease,box-shadow .15s ease}
    .btn:hover{background:var(--primary-600);box-shadow:0 10px 22px rgba(37,99,235,.3)}
    .btn:active{transform:translateY(1px)}
    .msg{min-height:1.2em;margin-top:8px;font-weight:600}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--error)}
    footer{margin-top:12px;text-align:center;font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="header">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Comune Oliveto Lario</h1>
        <p class="sub">Seleziona la struttura, scrivi il nome reale e premi <strong>Salva</strong>.</p>
      </div>
    </div>

    <div class="field">
      <label for="key">Struttura (nome temporaneo)</label>
      <div class="select-wrap"><select id="key"></select></div>
    </div>

    <div class="field">
      <label for="value">Nome reale</label>
      <input id="value" type="text" placeholder="Es. Casa al Lago" autocomplete="name" />
      <div class="actions"><button id="save" type="button" class="btn">Salva</button></div>
      <p class="msg" id="msg" aria-live="polite"></p>
    </div>

    <footer>Le modifiche restano salvate su questo dispositivo.</footer>
    <pre id="diag" style="display:none;margin-top:8px;background:#0b1021;color:#cbd5e1;padding:12px;border-radius:12px;overflow:auto;max-height:180px;font-size:.85rem"></pre>
  </main>

  <script>
    // ===== Config =====
    const DEFAULT_SRC = 'https://fulviogilardoni.github.io/comune_olivetolario/temp_names.json';

    // ===== Stato =====
    let TEMP_NAMES = [];
    const STORAGE_KEY = 'cv-mapping'; // { oldName: newName }

    // ===== Helpers =====
    const $ = (s) => document.querySelector(s);
    const keySel = $('#key');
    const valInput = $('#value');
    const msg = $('#msg');

    function loadMap(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
    function saveMap(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }

    function normalizeToNames(data){
      const unwrap = (x)=> Array.isArray(x) ? x : (x && typeof x==='object' && (Array.isArray(x.items)||Array.isArray(x.data)) ? (x.items||x.data) : x);
      const arr = unwrap(data);
      if (!Array.isArray(arr)) throw new Error('Formato JSON non valido');
      const out = [];
      for (let i=0;i<arr.length;i++){
        const it = arr[i];
        if (typeof it === 'string') { const s = it.trim(); if(s) out.push(s); continue; }
        if (it && typeof it === 'object'){
          const cand = ['nome','name','denominazione','struttura','label','value','titolo'];
          let s = null; for (let k=0;k<cand.length;k++){ const ck=cand[k]; if (typeof it[ck]==='string' && it[ck].trim()){ s = it[ck].trim(); break; } }
          if (!s){ for (const k in it){ if (typeof it[k]==='string' && it[k].trim()){ s = it[k].trim(); break; } } }
          if (s) out.push(s);
        }
      }
      // dedup + sort
      const set = Object.create(null); const unique = [];
      for (let i=0;i<out.length;i++){ const v=out[i]; if(!set[v]){ set[v]=1; unique.push(v); } }
      unique.sort(function(a,b){ return a.localeCompare(b); });
      return unique;
    }

    function fillSelect(){
      // Costruzione DOM sicura (niente innerHTML)
      while (keySel.firstChild) keySel.removeChild(keySel.firstChild);
      if (!TEMP_NAMES || TEMP_NAMES.length===0){
        keySel.disabled = true;
        msg.className = 'msg err';
        msg.textContent = 'Nessuna struttura trovata.';
        return;
      }
      keySel.disabled = false;
      const frag = document.createDocumentFragment();
      for (let i=0;i<TEMP_NAMES.length;i++){
        const n = TEMP_NAMES[i];
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n; frag.appendChild(opt);
      }
      keySel.appendChild(frag);
      msg.className = 'msg'; msg.textContent = '';
    }

    function syncValue(){ const map = loadMap(); valInput.value = map[keySel.value] || ''; msg.textContent=''; }
    function ok(t){ msg.className = 'msg ok'; msg.textContent = t; setTimeout(()=>{ if (msg.classList.contains('ok')) msg.textContent=''; }, 1500); }

    async function loadNames(){
      const qsSrc = new URLSearchParams(location.search).get('src');
      const src = qsSrc || DEFAULT_SRC;
      const candidates = [src, './temp_names.json', 'temp_names.json'];
      const diag = document.getElementById('diag');
      if (diag) { diag.style.display = 'none'; diag.textContent = ''; }
      let lastErr = null; let lastTxt = '';
      for (let i=0;i<candidates.length;i++){
        const u = candidates[i];
        try {
          const res = await fetch(u + (u.indexOf('?')>-1?'&':'?') + 't=' + Date.now(), { cache:'no-store' });
          if (!res.ok) throw new Error('HTTP ' + res.status + ' su ' + u);
          const text = await res.text(); lastTxt = text.slice(0,200);
          let data; try { data = JSON.parse(text); } catch { data = text.split(/
?
/).map(s=>s.trim()).filter(Boolean); }
          TEMP_NAMES = normalizeToNames(data);
          if (!TEMP_NAMES || TEMP_NAMES.length===0) throw new Error('Lista vuota da ' + u);
          fillSelect(); if (TEMP_NAMES.length>0) syncValue();
          msg.className = 'msg ok'; msg.textContent = 'Caricate ' + TEMP_NAMES.length + ' strutture.';
          return;
        } catch(e){ lastErr = e; }
      }
      // se arrivo qui, fallito tutto
      msg.className = 'msg err';
      msg.textContent = 'Non riesco a caricare l\'elenco strutture.';
      if (diag) { diag.style.display = 'block'; diag.textContent = 'DEBUG
URL provati:
' + candidates.join('
') + '

Ultimo errore:
' + (lastErr && (lastErr.stack || lastErr.message || String(lastErr))); }
    }

    document.addEventListener('DOMContentLoaded', function(){
      loadNames();
      keySel.addEventListener('change', syncValue);
      valInput.addEventListener('keydown', function(ev){ if (ev.key==='Enter'){ document.getElementById('save').click(); }});
      document.getElementById('save').addEventListener('click', function(){
        const k = keySel.value || '';
        const v = (valInput.value || '').trim();
        if (!k) return;
        const map = loadMap();
        map[k] = v; saveMap(map); ok('âœ“ Salvato');
      });
    });
  </script>
</body>
</html>
