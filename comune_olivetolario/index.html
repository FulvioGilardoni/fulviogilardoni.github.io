<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Case Vacanza ‚Äì Rinominatore semplice</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans"; }
    body { margin: 2rem; max-width: 900px; }
    h1 { font-size: 1.25rem; margin-bottom: .25rem; }
    p.lead { color: #444; margin-top: 0; }
    .field { display: grid; grid-template-columns: 1fr; gap: .5rem; margin: 1rem 0 1.5rem; }
    label { font-weight: 600; }
    select, input[type="text"], button { font-size: 1rem; padding: .55rem .6rem; }
    .actions { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .25rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: .5rem .6rem; vertical-align: middle; }
    th { text-align: left; background: #fafafa; }
    .msg { min-height: 1.2em; color: #166534; margin-top: .5rem; }
    .row-actions { display: flex; gap: .25rem; }
    .small { font-size: .9rem; color: #666; }
  </style>
</head>
<body>
  <h1>Case Vacanza ‚Äì Associa nome temporaneo ‚Üí nome corretto</h1>
  <p class="lead">All'apertura del sito i nomi temporanei vengono caricati <strong>automaticamente</strong> dal tuo JSON (nessuna azione manuale). Puoi opzionalmente passare <code>?src=https://...</code> per sovrascrivere la sorgente.</p>

  <!-- RIGA 1 -->
  <div class="field">
    <label for="key">Nome temporaneo</label>
    <select id="key"></select>
  </div>

  <!-- RIGA 2 -->
  <div class="field">
    <label for="value">Nome corretto</label>
    <input id="value" type="text" placeholder="Scrivi il nome ufficiale/corretto‚Ä¶" />
    <div class="actions">
      <button id="save" type="button">Salva</button>
      <button id="clearOne" type="button" title="Cancella solo la voce selezionata">Cancella</button>
      <button id="exportJson" type="button" title="Scarica il mapping JSON vecchio‚Üínuovo">Esporta mapping JSON</button>
      <button id="exportCsv" type="button" title="Scarica il mapping CSV vecchio‚Üínuovo">Esporta mapping CSV</button>
    </div>
    <p class="msg" id="msg"></p>
  </div>

  <!-- TABELLA COMPLETA -->
  <table id="tbl">
    <thead>
      <tr>
        <th style="width:45%">Nome temporaneo</th>
        <th>Nome corretto</th>
        <th style="width:1%">&nbsp;</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="small">Il mapping √® salvato localmente nel browser (<code>localStorage</code>). Per ambienti multi-utente collega a Firestore o a una Minimal API. Se il JSON √® su un altro dominio, abilita il <em>CORS</em>.</p>

  <script>
    // === Sorgente fissa ===
    // Metti il tuo file JSON nello stesso repository del sito e aggiorna il path qui sotto.
    // Esempio: './temp_names.json' (consigliato). In alternativa un URL assoluto (necessita CORS).
    const DEFAULT_SRC = './temp_names.json';

    // === Stato ===
    let TEMP_NAMES = [];            // viene popolato dal tuo JSON
    const STORAGE_KEY = "cv-mapping"; // { oldName: newName }

    const $ = (sel) => document.querySelector(sel);
    const keySel = $("#key");
    const valInput = $("#value");
    const msg = $("#msg");
    const tblBody = document.querySelector("#tbl tbody");

    // === Persistenza locale del mapping ===
    function loadMap() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; }
    }
    function saveMap(map) { localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); }

    // === Parsing flessibile del JSON in ingresso ===
    function normalizeToNames(data) {
      // Accetta: ["A", "B", ...] OPPURE [{nome:"A"}, {name:"B"}, ...]
      // Se data ha wrapper tipo {items:[...]}, {data:[...]}, aprilo.
      const unwrap = (x) => {
        if (Array.isArray(x)) return x;
        if (x && typeof x === 'object') {
          for (const k of ['items','data','result','results','rows']) {
            if (Array.isArray(x[k])) return x[k];
          }
        }
        return x;
      };
      const arr = unwrap(data);
      if (!Array.isArray(arr)) throw new Error('Il JSON deve essere un array o contenere un array in items/data');
      const out = [];
      for (const it of arr) {
        if (it == null) continue;
        if (typeof it === 'string') { out.push(it.trim()); continue; }
        if (typeof it === 'object') {
          // prova varie chiavi plausibili
          const keys = ['nome','name','denominazione','struttura','label','value','titolo'];
          let found = null;
          for (const k of keys) {
            if (typeof it[k] === 'string' && it[k].trim()) { found = it[k].trim(); break; }
          }
          if (!found) {
            // fallback: prima propriet√† stringa
            for (const k in it) { if (typeof it[k] === 'string' && it[k].trim()) { found = it[k].trim(); break; } }
          }
          if (found) out.push(found);
        }
      }
      // dedup + sort
      return Array.from(new Set(out.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }

    // === UI helpers ===
    function fillSelect() { keySel.innerHTML = TEMP_NAMES.map(k => `<option>${k}</option>`).join(""); }
    function renderTable() {
      const map = loadMap();
      const rows = TEMP_NAMES.map(k => {
        const v = map[k] ?? "";
        return `<tr data-k="${k}">
          <td>${k}</td>
          <td><input type="text" value="${v.replace(/"/g, '&quot;')}" placeholder="Nome corretto‚Ä¶" /></td>
          <td class="row-actions">
            <button class="save-row" title="Salva">üíæ</button>
            <button class="clear-row" title="Cancella">üóëÔ∏è</button>
          </td>
        </tr>`;
      }).join("");
      tblBody.innerHTML = rows;
    }
    function syncValueFromSelect() {
      const map = loadMap();
      valInput.value = map[keySel.value] ?? "";
      msg.textContent = "";
    }
    function showOk(text) { msg.textContent = text; setTimeout(()=>msg.textContent="", 1500); }

    // === Export mapping ===
    function exportMappingJson() {
      const map = loadMap();
      const arr = TEMP_NAMES.map(old => ({ old, new: map[old] ?? "" }));
      const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mapping_case_vacanza.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function exportMappingCsv() {
      const map = loadMap();
      const rows = ['old,new', ...TEMP_NAMES.map(old => `"${old.replaceAll('"','""')}","${(map[old]??"").replaceAll('"','""')}"`)];
      const blob = new Blob([rows.join('
')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'mapping_case_vacanza.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // === Caricamento iniziale automatico ===
    async function loadFromUrl(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      TEMP_NAMES = normalizeToNames(data);
      fillSelect();
      renderTable();
      syncValueFromSelect();
      showOk(`Caricati ${TEMP_NAMES.length} nomi`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Carica automaticamente il JSON di default o quello passato via ?src=
      const urlSrc = new URLSearchParams(location.search).get('src');
      const src = urlSrc || DEFAULT_SRC;
      loadFromUrl(src).catch(e => msg.textContent = 'Errore caricamento iniziale: ' + e.message);

      // Salvataggi
      keySel.addEventListener('change', syncValueFromSelect);
      $('#save').addEventListener('click', () => {
        const k = keySel.value.trim();
        const v = valInput.value.trim();
        const map = loadMap();
        map[k] = v; saveMap(map); renderTable(); showOk('‚úì Salvato');
      });
      $('#clearOne').addEventListener('click', () => {
        const k = keySel.value; const map = loadMap(); delete map[k]; saveMap(map);
        valInput.value = ''; renderTable(); showOk('Chiave rimossa');
      });

      // Tabella azioni
      tblBody.addEventListener('click', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const tr = e.target.closest('tr'); const k = tr.dataset.k; const input = tr.querySelector('input');
        const map = loadMap();
        if (btn.classList.contains('save-row')) { map[k] = input.value.trim(); saveMap(map); if (keySel.value===k) valInput.value = input.value.trim(); showOk('‚úì Salvato: ' + k); }
        if (btn.classList.contains('clear-row')) { delete map[k]; saveMap(map); input.value=''; if (keySel.value===k) valInput.value=''; showOk('Rimossa: ' + k); }
      });

      // Export
      $('#exportJson').addEventListener('click', exportMappingJson);
      $('#exportCsv').addEventListener('click', exportMappingCsv);
    });

    // Nota: se apri il file in locale (file://) il fetch pu√≤ essere bloccato. Pubblica il sito su HTTPS (GitHub Pages/Netlify/Vercel).
  </script>
</body>
</html>
