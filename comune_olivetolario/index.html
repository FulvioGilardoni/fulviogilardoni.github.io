<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comune Oliveto Lario</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --ring: rgba(37, 99, 235, .35);
      --ok: #065f46;
      --error: #b91c1c;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, #f8fafc, #eef2ff 60%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--text);
      display: grid; place-items: center; padding: 1.25rem;
    }
    .card {
      width: 100%; max-width: 640px; background: var(--card);
      border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 1.25rem; overflow: hidden;
    }
    .header { display: flex; gap: .75rem; align-items: center; margin-bottom: .5rem; }
    .logo { width: 42px; height: 42px; border-radius: 12px; background: radial-gradient(circle at 30% 30%, #93c5fd, #3b82f6); box-shadow: inset 0 0 0 2px rgba(255,255,255,.6); }
    h1 { font-size: 1.25rem; margin: 0; }
    p.sub { margin: .25rem 0 0 0; color: var(--muted); font-size: .95rem; }

    .field { margin-top: 1rem; }
    label { display: block; font-weight: 600; margin-bottom: .5rem; }

    /* --- Select super semplice ma "carino" e PIÙ ALTO --- */
    .select-wrap { position: relative; }
    select {
      width: 100%; font-size: 1.05rem; padding: 1.1rem 3rem 1.1rem 1rem; /* più alto */
      border-radius: 14px; border: 1px solid #e5e7eb; background: #fff; outline: none;
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      transition: box-shadow .15s, border-color .15s, transform .05s;
    }
    select:focus { border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring); }
    .select-wrap::after { /* freccina */
      content: ""; position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      border: 6px solid transparent; border-top-color: #6b7280; pointer-events: none;
    }

    input[type="text"] {
      width: 100%; font-size: 1.05rem; padding: 1.05rem 1rem; /* più alto */
      border-radius: 14px; border: 1px solid #e5e7eb; background: #fff; outline: none;
      transition: box-shadow .15s, border-color .15s, transform .05s;
    }
    input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring); }

    .actions { margin-top: 1rem; display: flex; gap: .75rem; }
    .btn { appearance: none; cursor: pointer; border: none; border-radius: 14px; padding: 1rem 1.25rem; font-size: 1.05rem; font-weight: 700; letter-spacing: .2px; background: var(--primary); color: #fff; box-shadow: 0 8px 16px rgba(37,99,235,.25); transition: transform .06s ease, background .15s ease, box-shadow .15s ease; }
    .btn:active { transform: translateY(1px); }
    .btn:hover { background: var(--primary-600); box-shadow: 0 10px 22px rgba(37,99,235,.3); }

    .msg { min-height: 1.2em; margin-top: .5rem; font-weight: 600; }
    .msg.ok { color: var(--ok); }
    .msg.err { color: var(--error); }

    footer { margin-top: 1rem; text-align: center; font-size: .85rem; color: var(--muted); }
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="header">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Comune Oliveto Lario</h1>
        <p class="sub">Seleziona la struttura, scrivi il nome reale e premi <strong>Salva</strong>.</p>
      </div>
    </div>

    <div class="field">
      <label for="key">Struttura (nome temporaneo)</label>
      <div class="select-wrap">
        <select id="key" aria-describedby="keyHelp"></select>
      </div>
    </div>

    <div class="field">
      <label for="value">Nome reale</label>
      <input id="value" type="text" placeholder="Es. Casa al Lago" autocomplete="name" />
      <div class="actions">
        <button id="save" type="button" class="btn">Salva</button>
      </div>
      <p class="msg" id="msg" aria-live="polite"></p>
    </div>

    <footer>Le tue modifiche restano salvate in questo dispositivo.</footer>
  </main>

  <script>
    // ===== Config minimal =====
    // Il JSON con i nomi temporanei viene caricato automaticamente all'apertura della pagina.
    // Metti il tuo file accanto a index.html e lascia il path relativo qui sotto.
    const DEFAULT_SRC = 'https://fulviogilardoni.github.io/comune_olivetolario/temp_names.json';

    // ===== Stato =====
    let TEMP_NAMES = [];
    const STORAGE_KEY = 'cv-mapping'; // { oldName: newName }

    // ===== Helpers =====
    const $ = (s) => document.querySelector(s);
    const keySel = $('#key');
    const valInput = $('#value');
    const msg = $('#msg');

    function loadMap(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
    function saveMap(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }

    function normalizeToNames(data){
      const unwrap = (x) => Array.isArray(x) ? x : (x && typeof x==='object' && (Array.isArray(x.items)||Array.isArray(x.data)) ? (x.items||x.data) : x);
      const arr = unwrap(data);
      if (!Array.isArray(arr)) throw new Error('Formato JSON non valido');
      const out = [];
      for (const it of arr){
        if (typeof it === 'string') out.push(it.trim());
        else if (it && typeof it === 'object'){
          const cand = ['nome','name','denominazione','struttura','label','value','titolo'];
          let s = null; for (const k of cand){ if (typeof it[k]==='string' && it[k].trim()){ s = it[k].trim(); break; } }
          if (!s){ for (const k in it){ if (typeof it[k]==='string' && it[k].trim()){ s = it[k].trim(); break; } } }
          if (s) out.push(s);
        }
      }
      return Array.from(new Set(out.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }

    function fillSelect(){
      if (!TEMP_NAMES || TEMP_NAMES.length === 0){
        msg.className = 'msg err';
        msg.textContent = 'Nessuna struttura trovata nel JSON.';
        keySel.innerHTML = '';
        return;
      }
      keySel.innerHTML = TEMP_NAMES.map(n=>`<option>${n}</option>`).join('');
      msg.className = 'msg';
      msg.textContent = '';
    }</option>`).join(''); }
    function syncValue(){ const map = loadMap(); valInput.value = map[keySel.value] ?? ''; msg.textContent=''; }
    function ok(t){ msg.className = 'msg ok'; msg.textContent = t; setTimeout(()=> { if (msg.classList.contains('ok')) msg.textContent=''; }, 1500); }

    async function loadNames(){
      // Prova più path comuni se il primo fallisce
      const candidates = [DEFAULT_SRC, 'temp_names.json', './data/temp_names.json'];
      let lastErr = null;
      for (const url of candidates){
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          TEMP_NAMES = normalizeToNames(data);
          fillSelect();
          syncValue();
          return;
        } catch(e){ lastErr = e; }
      }
      // Se siamo qui, nessun path ha funzionato
      msg.className = 'msg err';
      if (location.protocol === 'file:') {
        msg.textContent = 'Non posso leggere temp_names.json se la pagina è aperta come file. Aprila tramite http/https.';
      } else {
        msg.textContent = 'Non riesco a leggere temp_names.json. Verifica path/nome o CORS.';
      }
      console.warn('Errore caricamento JSON', lastErr);
    });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        TEMP_NAMES = normalizeToNames(data);
        fillSelect();
        syncValue();
        msg.textContent = '';
      } catch(err){
        if (location.protocol === 'file:') {
          msg.textContent = 'Non posso leggere temp_names.json se il file è aperto direttamente. Apri la pagina tramite un indirizzo http/https.';
        } else {
          msg.textContent = 'Non riesco a leggere temp_names.json. Verifica che sia nella stessa cartella e accessibile.';
        }
        console.warn('loadNames error', err);
      }
    });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      TEMP_NAMES = normalizeToNames(data);
      fillSelect();
      syncValue();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadNames().catch(e => msg.textContent = 'Errore caricamento dati');

      keySel.addEventListener('change', syncValue);
      valInput.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ $('#save').click(); }});
      $('#save').addEventListener('click', () => {
        const k = keySel.value.trim();
        const v = valInput.value.trim();
        const map = loadMap();
        map[k] = v; saveMap(map); ok('✓ Salvato');
      });
    });
  </script>
</body>
</html>
