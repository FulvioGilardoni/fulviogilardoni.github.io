<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rinomina Struttura</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --ring: rgba(37, 99, 235, .35);
      --ok: #065f46;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, #f8fafc, #eef2ff 60%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      color: var(--text);
      display: grid; place-items: center; padding: 1.25rem;
    }
    .card {
      width: 100%; max-width: 640px; background: var(--card);
      border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 1.25rem; overflow: hidden;
    }
    .header {
      display: flex; gap: .75rem; align-items: center; margin-bottom: .5rem;
    }
    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, #93c5fd, #3b82f6);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
    }
    h1 { font-size: 1.25rem; margin: 0; }
    p.sub { margin: .25rem 0 0 0; color: var(--muted); font-size: .95rem; }

    .field { margin-top: 1rem; }
    label { display: block; font-weight: 600; margin-bottom: .4rem; }
    select, input[type="text"] {
      width: 100%; font-size: 1.05rem; padding: .9rem 1rem; border-radius: 14px;
      border: 1px solid #e5e7eb; background: #fff; outline: none;
      transition: box-shadow .15s, border-color .15s, transform .05s;
    }
    select:focus, input[type="text"]:focus {
      border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring);
    }

    .actions { margin-top: 1rem; display: flex; gap: .75rem; }
    .btn {
      appearance: none; cursor: pointer; border: none; border-radius: 14px;
      padding: .9rem 1.2rem; font-size: 1.05rem; font-weight: 700; letter-spacing: .2px;
      background: var(--primary); color: #fff; box-shadow: 0 8px 16px rgba(37,99,235,.25);
      transition: transform .06s ease, background .15s ease, box-shadow .15s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn:hover { background: var(--primary-600); box-shadow: 0 10px 22px rgba(37,99,235,.3); }

    .msg { min-height: 1.2em; margin-top: .5rem; color: var(--ok); font-weight: 600; }

    footer { margin-top: 1rem; text-align: center; font-size: .85rem; color: var(--muted); }
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="header">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Rinomina la tua struttura</h1>
        <p class="sub">Seleziona la struttura, scrivi il nome reale e premi <strong>Salva</strong>.</p>
      </div>
    </div>

    <div class="field">
      <label for="key">Struttura (nome temporaneo)</label>
      <select id="key" aria-describedby="keyHelp"></select>
    </div>

    <div class="field">
      <label for="value">Nome reale</label>
      <input id="value" type="text" placeholder="Es. Casa al Lago" autocomplete="name" />
      <div class="actions">
        <button id="save" type="button" class="btn">Salva</button>
      </div>
      <p class="msg" id="msg" aria-live="polite"></p>
    </div>

    <footer>Le tue modifiche restano salvate in questo dispositivo.</footer>
  </main>

  <script>
    // ===== Config minimal =====
    // Il JSON con i nomi temporanei viene caricato automaticamente all'apertura della pagina.
    // Metti il tuo file accanto a index.html e lascia il path relativo qui sotto.
    const DEFAULT_SRC = './temp_names.json';

    // ===== Stato =====
    let TEMP_NAMES = [];
    const STORAGE_KEY = 'cv-mapping'; // { oldName: newName }

    // ===== Helpers =====
    const $ = (s) => document.querySelector(s);
    const keySel = $('#key');
    const valInput = $('#value');
    const msg = $('#msg');

    function loadMap(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
    function saveMap(m){ localStorage.setItem(STORAGE_KEY, JSON.stringify(m)); }

    function normalizeToNames(data){
      const unwrap = (x) => Array.isArray(x) ? x : (x && typeof x==='object' && (Array.isArray(x.items)||Array.isArray(x.data)) ? (x.items||x.data) : x);
      const arr = unwrap(data);
      if (!Array.isArray(arr)) throw new Error('Formato JSON non valido');
      const out = [];
      for (const it of arr){
        if (typeof it === 'string') out.push(it.trim());
        else if (it && typeof it === 'object'){
          const cand = ['nome','name','denominazione','struttura','label','value','titolo'];
          let s = null; for (const k of cand){ if (typeof it[k]==='string' && it[k].trim()){ s = it[k].trim(); break; } }
          if (!s){ for (const k in it){ if (typeof it[k]==='string' && it[k].trim()){ s = it[k].trim(); break; } } }
          if (s) out.push(s);
        }
      }
      return Array.from(new Set(out.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }

    function fillSelect(){ keySel.innerHTML = TEMP_NAMES.map(n=>`<option>${n}</option>`).join(''); }
    function syncValue(){ const map = loadMap(); valInput.value = map[keySel.value] ?? ''; msg.textContent=''; }
    function ok(t){ msg.textContent = t; setTimeout(()=> msg.textContent='', 1500); }

    async function loadNames(){
      const res = await fetch(DEFAULT_SRC, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      TEMP_NAMES = normalizeToNames(data);
      fillSelect();
      syncValue();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadNames().catch(e => msg.textContent = 'Errore caricamento dati');

      keySel.addEventListener('change', syncValue);
      valInput.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ $('#save').click(); }});
      $('#save').addEventListener('click', () => {
        const k = keySel.value.trim();
        const v = valInput.value.trim();
        const map = loadMap();
        map[k] = v; saveMap(map); ok('âœ“ Salvato');
      });
    });
  </script>
</body>
</html>
